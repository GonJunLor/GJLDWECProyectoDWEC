<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas</title>
    <style>
        #colores{
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #colores div{
            display: block;
            width: 150px;
        }
        input[type="range"] {
            -webkit-appearance: none; /* Chrome, Safari, Opera */
            appearance: none;
            background: transparent; /* Quita el fondo por defecto */
            cursor: pointer;
            width: 350px;
        }
        /* Para Chrome, Safari y Edge */
        #rojo::-webkit-slider-runnable-track {
            background: #ff4d4d; /* Color rojo */
            height: 8px;
            border-radius: 5px;
        }

        #verde::-webkit-slider-runnable-track {
            background: #4dff88; /* Color verde */
            height: 8px;
            border-radius: 5px;
        }

        #azul::-webkit-slider-runnable-track {
            background: #4d94ff; /* Color azul */
            height: 8px;
            border-radius: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -4px; /* Centra el botón sobre la pista */
            background-color: #333;
            height: 16px;
            width: 16px;
            border-radius: 50%;
        }
        #barraHerramientas{
            border: 1px solid #333;
            border-radius: 10px;
            padding: 10px;
            margin: 10px;
            width: 950px;
            display: flex;
            gap: 10px;
        }
        #barraHerramientas input{
            display: none;
        }
        #barraHerramientas label{
            display: block;
            border-radius: 10px;
            width: 50px;
            height: 50px;
        }
        #barraHerramientas input[name="colores"]:checked + label{
            border: 3px solid black;
        }
        #barraHerramientas #pintarNegro:checked + label{
            border: 3px solid red;
        }
        #canvas2 {
            margin: 50px;
            touch-action: none;
            -webkit-tap-highlight-color: transparent; /* Evita el destello azul al tocar */
            user-select: none; /* Evita seleccionar texto accidentalmente mientras dibujas */
        }
        .herramienta{
            background-color: aliceblue;
            border: 1px solid gray;
            border-radius: 5px;
            text-align: center;
            line-height: 50px;
        }
        .herramienta:hover{
            background-color: beige;
            border: 1px solid gray;
            border-radius: 5px;
        }
        input[name="herramientas"]:checked + .herramienta{
            background-color: beige;
            /* border: 3px solid red; */
        }
    </style>
</head>
<body>
    <div id="colores">
        <img src="../media/images/paisaje.png" alt="">
        <canvas id="canvas" width=300 height=168 style="background-color: bisque; border: 2px solid black;"></canvas>
        <div>
            <input type="range" name="rojo" id="rojo" min="-100" max="100" value="0">
            <input type="range" name="verde" id="verde" min="-100" max="100" value="0">
            <input type="range" name="azul" id="azul" min="-100" max="100" value="0">
            <button id="resetColores">Reset</button>
        </div>

    </div>
    <div id="barraHerramientas">
        <input type="radio" name="colores" id="pintarNegro" value="rgb(0,0,0)" checked>
        <label for="pintarNegro" style="background-color: black;"></label>
        <input type="radio" name="colores" id="pintarRojo" value="rgb(255,0,0)">
        <label for="pintarRojo" style="background-color: red;"></label>
        <input type="radio" name="colores" id="pintarVerde" value="rgb(0,128,0)">
        <label for="pintarVerde" style="background-color: green;"></label>
        <input type="radio" name="colores" id="pintarAzul" value="rgb(0,0,255)">
        <label for="pintarAzul" style="background-color: blue;"></label>
        <input type="radio" name="colores" id="pintarAmarillo" value="rgb(255,255,0)">
        <label for="pintarAmarillo" style="background-color: yellow;"></label>
        <input type="radio" name="herramientas" id="herrRecta" value="recta">
        <label for="herrRecta" class="herramienta">Recta</label>
        <input type="radio" name="herramientas" id="herrLibre" value="libre">
        <label for="herrLibre" class="herramienta">Libre</label>
        <input type="radio" name="herramientas" id="herrRectangulo" value="rectangulo">
        <label for="herrRectangulo" class="herramienta">Rect</label>
        <button id="btnSpen">Modo: Todos</button>
        <button id="btnBorrar">Borrar Lienzo</button>
    </div>
    <div id="lienzo">
        <canvas id="canvas2" 
        width="1000" height="1000"
        style="background-color: bisque; border: 2px solid black;"></canvas>
    </div>

    <script>
        /* Canva para la imagen */
        const canva = document.getElementById("canvas");
        const c = canva.getContext("2d", { willReadFrequently: true });

        var barraRojo = document.getElementById("rojo");
        var barraVerde = document.getElementById("verde");
        var barraAzul = document.getElementById("azul");
        var resetBarras = document.getElementById('resetColores');

        var copiaImagen = [];

        var foto = document.createElement("img");

        zonaImagenes();

        /* Canva para dibujar  */
        var tipoHerramienta = '';

        /* Botones de colores y herramientas */
        // Selección de colores
        document.querySelectorAll('input[name="colores"]').forEach(input => {
            input.addEventListener('change', (e) => {
                colorPincel = e.target.value;
            });
        });
        document.querySelectorAll('input[name="herramientas"]').forEach(input => {
            input.addEventListener('change', (e) => {
                tipoHerramienta = e.target.value;
                console.log('herr selec: ' + tipoHerramienta);
            });
        });
        document.getElementById('btnBorrar').addEventListener('click',()=>{
            lienzo.clearRect(0, 0, canva2.width, canva2.height);
        })

        colorPincel = "rgb(0,0,0)";

        const canva2 = document.getElementById("canvas2");
        const lienzo = canva2.getContext("2d", { willReadFrequently: true });

        // lienzo.fillStyle = colorPincel;

        // Eventos para el ratón
        // canva2.addEventListener("mousedown",(e)=>{
        //     xAnterior = e.offsetX;
        //     yAnterior = e.offsetY;

        //     if (tipoHerramienta=='recta' || tipoHerramienta === 'rectangulo') {
        //         /* Guardo el estado del canva porque voy a estar dibujando la recta constantemente solo para visualizarla
        //         pero cuando suelte el ratón quiero que dibuje solo la ultima posición, para ello restaura el canva y dibuja la recta */
        //         snapshot = lienzo.getImageData(0, 0, canva2.width, canva2.height);
        //     } 
        //     canva2.addEventListener("mousemove",movimiento)
        // })

        // canva2.addEventListener("mouseup",()=>{
        //     canva2.removeEventListener("mousemove",movimiento)
        // })

        // canva2.addEventListener("mouseover",()=>{
        //     canva2.removeEventListener("mousemove",movimiento)
        // })
        
        // Eventos para pantalla tactil
        // canva2.addEventListener("touchstart",(e)=>{
        //     if (e.cancelable) e.preventDefault();

        //     const rect = canva2.getBoundingClientRect();
        //     xAnteriorTactil = e.touches[0].clientX - rect.left;
        //     yAnteriorTactil = e.touches[0].clientY - rect.top;

        //     if (tipoHerramienta=='recta' || tipoHerramienta === 'rectangulo') {
        //         /* Guardo el estado del canva porque voy a estar dibujando la recta constantemente solo para visualizarla
        //         pero cuando suelte el ratón quiero que dibuje solo la ultima posición, para ello restaura el canva y dibuja la recta */
        //         snapshot = lienzo.getImageData(0, 0, canva2.width, canva2.height);
        //     } 
        //     canva2.addEventListener("touchmove",movimientoTactil, { passive: false })
        // }, { passive: false });

        // canva2.addEventListener("touchend",()=>{
        //     if (e.cancelable) e.preventDefault();
        //     canva2.removeEventListener("touchmove",movimientoTactil, { passive: false })
        // }, { passive: false });

        // Eventos raton, tactil y spen a la vez
        // Variables de control
        let snapshot;
        let xAnterior, yAnterior;
        let soloSpen = false;

        const btnSpen = document.getElementById('btnSpen');
        btnSpen.addEventListener('click', () => {
            soloSpen = !soloSpen;
            btnSpen.textContent = soloSpen ? "Modo: Solo S Pen" : "Modo: Todos";
            btnSpen.style.backgroundColor = soloSpen ? "#4d94ff" : "";
        });

        // Evento de inicio (unificado)
        canva2.addEventListener("pointerdown", (e) => {
            // Filtro para S Pen
            if (soloSpen && e.pointerType !== 'pen') return;

            // Esto asegura que el evento siga al puntero aunque salga un poco del canvas
            canva2.setPointerCapture(e.pointerId);

            const rect = canva2.getBoundingClientRect();
            xAnterior = e.clientX - rect.left;
            yAnterior = e.clientY - rect.top;

            if (tipoHerramienta === 'recta' || tipoHerramienta === 'rectangulo') {
                snapshot = lienzo.getImageData(0, 0, canva2.width, canva2.height);
            }

            canva2.addEventListener("pointermove", movimientoPointer);
        });

        // Evento de fin (unificado)
        canva2.addEventListener("pointerup", (e) => {
            canva2.releasePointerCapture(e.pointerId);
            canva2.removeEventListener("pointermove", movimientoPointer);
        });

        // Funciones
        function movimiento(e) {
            
            lienzo.lineWidth = 5;
            lienzo.lineJoin = "round"; // Para que las esquinas sean suaves
            lienzo.lineCap = "round";  // Para que el trazo no sea cuadrado
            lienzo.strokeStyle = colorPincel;
            
            if (tipoHerramienta=='libre') {
                lienzo.beginPath();
                // Movemos al punto donde estaba el mouse hace un milisegundo
                lienzo.moveTo(xAnterior, yAnterior); 
                // Trazamos hasta la posición actual
                lienzo.lineTo(e.offsetX, e.offsetY); 
                lienzo.stroke();
                // Actualizamos el punto anterior para el siguiente movimiento
                xAnterior = e.offsetX;
                yAnterior = e.offsetY;
            } else if(tipoHerramienta === 'recta'){
                // Restauramos el dibujo original para borrar la línea "fantasma" anterior
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.moveTo(xAnterior, yAnterior);
                lienzo.lineTo(e.offsetX, e.offsetY);
                lienzo.stroke();
            } else if(tipoHerramienta === 'rectangulo'){
                // Restauramos el dibujo original para borrar la línea "fantasma" anterior
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.strokeRect(xAnterior, yAnterior,e.offsetX-xAnterior, e.offsetY-yAnterior);
                lienzo.stroke();
            } 
        }

        function movimientoTactil(e) {
            if (e.cancelable) e.preventDefault();
            
            lienzo.lineWidth = 5;
            lienzo.lineJoin = "round"; // Para que las esquinas sean suaves
            lienzo.lineCap = "round";  // Para que el trazo no sea cuadrado
            lienzo.strokeStyle = colorPincel;

            const rect = canva2.getBoundingClientRect();
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
            
            if (tipoHerramienta=='libre') {
                lienzo.beginPath();
                // Movemos al punto donde estaba el mouse hace un milisegundo
                lienzo.moveTo(xAnteriorTactil, yAnteriorTactil); 
                // Trazamos hasta la posición actual
                lienzo.lineTo(x, y); 
                lienzo.stroke();
                // Actualizamos el punto anterior para el siguiente movimiento
                xAnteriorTactil = x;
                yAnteriorTactil = y;
            } else if(tipoHerramienta === 'recta'){
                // Restauramos el dibujo original para borrar la línea "fantasma" anterior
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.moveTo(xAnteriorTactil, yAnteriorTactil);
                lienzo.lineTo(x, y);
                lienzo.stroke();
            } else if(tipoHerramienta === 'rectangulo'){
                // Restauramos el dibujo original para borrar la línea "fantasma" anterior
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.strokeRect(xAnteriorTactil, yAnteriorTactil,x-xAnteriorTactil, y-yAnteriorTactil);
                lienzo.stroke();
            } 
        }

        function movimientoPointer(e) {
            // Si estamos en modo solo lápiz y detecta un dedo/ratón, no hace nada
            if (soloSpen && e.pointerType !== 'pen') return;

            // Prevenir scroll si es posible
            if (e.cancelable) e.preventDefault();

            const rect = canva2.getBoundingClientRect();
            const xActual = e.clientX - rect.left;
            const yActual = e.clientY - rect.top;

            // AJUSTE DE GROSOR: 
            // Si es pen, usamos la presión (e.pressure va de 0 a 1). 
            // Si es ratón o dedo, e.pressure suele ser 0.5 o 0, así que ponemos un mínimo.
            let grosorBase = 5;
            // Si hay presión (S Pen), multiplicamos. Si no (ratón), usamos grosor base.
            lienzo.lineWidth = (e.pointerType === 'pen' && e.pressure > 0) ? (grosorBase * e.pressure * 3) : grosorBase;

            // Evitamos que el grosor sea invisible
            if (lienzo.lineWidth < 1) lienzo.lineWidth = 2;

            lienzo.lineJoin = "round";
            lienzo.lineCap = "round";
            lienzo.strokeStyle = colorPincel;

            if (tipoHerramienta === 'libre') {
                lienzo.beginPath();
                lienzo.moveTo(xAnterior, yAnterior);
                lienzo.lineTo(xActual, yActual);
                lienzo.stroke();
                
                xAnterior = xActual;
                yAnterior = yActual;
            } else if (tipoHerramienta === 'recta') {
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.moveTo(xAnterior, yAnterior);
                lienzo.lineTo(xActual, yActual);
                lienzo.stroke();
            } else if (tipoHerramienta === 'rectangulo') {
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.strokeRect(xAnterior, yAnterior, xActual - xAnterior, yActual - yAnterior);
                // lienzo.stroke();
            }
        }

        function zonaImagenes() {
            
            foto.src="../media/images/paisaje.png";
            foto.addEventListener("load",()=>{
                
                c.drawImage(foto, 0, 0)
                console.log(c.getImageData(0,0,300,168));

                imgData = c.getImageData(0,0,300,168);
                let aFoto = imgData.data;
                const aFoto2 = imgData.data;

                copiaImagen = Array.from(imgData.data);

                barraRojo.addEventListener("input",()=>{
                    modificarImagen(c,aFoto,aFoto2,barraRojo.value,barraVerde.value,barraAzul.value)
                })
                barraVerde.addEventListener("input",()=>{
                    modificarImagen(c,aFoto,aFoto2,barraRojo.value,barraVerde.value,barraAzul.value)
                })
                barraAzul.addEventListener("input",()=>{
                    modificarImagen(c,aFoto,aFoto2,barraRojo.value,barraVerde.value,barraAzul.value)
                })
                resetBarras.addEventListener('click',()=>{
                    barraRojo.value=0
                    barraVerde.value=0
                    barraAzul.value=0
                    modificarImagen(c,aFoto,aFoto2,0,0,0)
                })
            })
        }
        
        function modificarImagen(c,aFoto, aFoto2,r,g,b) {

            for (let i = 0; i < aFoto.length; i+=4) {
                
                aFoto[i] = (copiaImagen[i]+(255*barraRojo.value/100))>255?255:(copiaImagen[i]+(255*barraRojo.value/100));
                aFoto[i + 1] = (copiaImagen[i + 1] + (255 * barraVerde.value / 100))>255?255:(copiaImagen[i + 1] + (255 * barraVerde.value / 100));
                aFoto[i + 2] = (copiaImagen[i + 2] + (255 * barraAzul.value / 100))>255?255:(copiaImagen[i + 2] + (255 * barraAzul.value / 100));
            }
            c.putImageData(imgData,0,0);
        }    


    </script>
</body>
</html>