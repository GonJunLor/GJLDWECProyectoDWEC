<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas</title>
    <style>
        #colores{
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #colores div{
            display: block;
            width: 150px;
        }
        input[type="range"] {
            -webkit-appearance: none; /* Chrome, Safari, Opera */
            appearance: none;
            background: transparent; /* Quita el fondo por defecto */
            cursor: pointer;
            width: 500px;
        }
        /* Para Chrome, Safari y Edge */
        #rojo::-webkit-slider-runnable-track {
            background: #ff4d4d; /* Color rojo */
            height: 8px;
            border-radius: 5px;
        }

        #verde::-webkit-slider-runnable-track {
            background: #4dff88; /* Color verde */
            height: 8px;
            border-radius: 5px;
        }

        #azul::-webkit-slider-runnable-track {
            background: #4d94ff; /* Color azul */
            height: 8px;
            border-radius: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -4px; /* Centra el botón sobre la pista */
            background-color: #333;
            height: 16px;
            width: 16px;
            border-radius: 50%;
        }
        #barraHerramientas{
            border: 1px solid #333;
            border-radius: 10px;
            padding: 10px;
            margin: 10px;
            width: 1460px;
            display: flex;
            gap: 10px;
        }
        #barraHerramientas input{
            display: none;
        }
        #barraHerramientas label{
            display: block;
            border-radius: 10px;
            width: 50px;
            height: 50px;
        }
        #barraHerramientas input:checked + label{
            border: 3px solid black;
        }
        #barraHerramientas #pintarNegro:checked + label{
            border: 3px solid red;
        }

    </style>
</head>
<body>
    <div id="colores">
        <img src="../media/images/paisaje.png" alt="">
        <canvas id="canvas" width=300 height=168 style="background-color: bisque; border: 2px solid black;"></canvas>
        <div>
            <input type="range" name="rojo" id="rojo" min="-100" max="100" value="0">
            <input type="range" name="verde" id="verde" min="-100" max="100" value="0">
            <input type="range" name="azul" id="azul" min="-100" max="100" value="0">
            <button id="resetColores">Reset</button>
        </div>

    </div>
    <div id="barraHerramientas">
        <input type="radio" name="colores" id="pintarNegro" value="rgb(0,0,0)" checked>
        <label for="pintarNegro" style="background-color: black;"></label>
        <input type="radio" name="colores" id="pintarRojo" value="rgb(255,0,0)">
        <label for="pintarRojo" style="background-color: red;"></label>
        <input type="radio" name="colores" id="pintarVerde" value="rgb(0,128,0)">
        <label for="pintarVerde" style="background-color: green;"></label>
        <input type="radio" name="colores" id="pintarAzul" value="rgb(0,0,255)">
        <label for="pintarAzul" style="background-color: blue;"></label>
        <input type="radio" name="colores" id="pintarAmarillo" value="rgb(255,255,0)">
        <label for="pintarAmarillo" style="background-color: yellow;"></label>
        <button id="herrRecta">Recta</button>
        <button id="herrLibre">Libre</button>
        <button id="herrRectangulo">Rectángulo</button>
    </div>
    <div id="lienzo">
        <canvas id="canvas2" width=1500 height=550 style="background-color: bisque; border: 2px solid black;"></canvas>
    </div>

    <script>
        /* Canva para la imagen */
        const canva = document.getElementById("canvas");
        const c = canva.getContext("2d", { willReadFrequently: true });

        var barraRojo = document.getElementById("rojo");
        var barraVerde = document.getElementById("verde");
        var barraAzul = document.getElementById("azul");
        var resetBarras = document.getElementById('resetColores');

        var copiaImagen = [];

        var foto = document.createElement("img");

        zonaImagenes();

        /* Canva para dibujar  */
        var tipoHerramienta = '';

        /* Botones de colores y herramientas */
        // Selección de colores
        document.querySelectorAll('input[name="colores"]').forEach(input => {
            input.addEventListener('change', (e) => {
                colorPincel = e.target.value;
            });
        });
        var herrRecta = document.getElementById('herrRecta');
        herrRecta.addEventListener('click',()=>{
            tipoHerramienta='recta';
            herrRecta.style.background = colorPincel;
        });
        document.getElementById('herrLibre').addEventListener('click',()=>tipoHerramienta='libre');
        document.getElementById('herrRectangulo').addEventListener('click',()=>tipoHerramienta='rectangulo');

        colorPincel = "rgb(0,0,0)";

        const canva2 = document.getElementById("canvas2");
        const lienzo = canva2.getContext("2d", { willReadFrequently: true });

        // lienzo.fillStyle = colorPincel;

        canva2.addEventListener("mousedown",(e)=>{
            xAnterior = e.offsetX;
            yAnterior = e.offsetY;

            if (tipoHerramienta=='recta' || tipoHerramienta === 'rectangulo') {
                /* Guardo el estado del canva porque voy a estar dibujando la recta constantemente solo para visualizarla
                pero cuando suelte el ratón quiero que dibuje solo la ultima posición, para ello restaura el canva y dibuja la recta */
                snapshot = lienzo.getImageData(0, 0, canva2.width, canva2.height);
            } 
            canva2.addEventListener("mousemove",movimiento)
        })

        canva2.addEventListener("mouseup",()=>{
            canva2.removeEventListener("mousemove",movimiento)
        })

        canva2.addEventListener("mouseover",()=>{
            canva2.removeEventListener("mousemove",movimiento)
        })
          
        function movimiento(e) {
            
            lienzo.lineWidth = 5;
            lienzo.lineJoin = "round"; // Para que las esquinas sean suaves
            lienzo.lineCap = "round";  // Para que el trazo no sea cuadrado
            lienzo.strokeStyle = colorPincel;
            
            if (tipoHerramienta=='libre') {
                lienzo.beginPath();
                // Movemos al punto donde estaba el mouse hace un milisegundo
                lienzo.moveTo(xAnterior, yAnterior); 
                // Trazamos hasta la posición actual
                lienzo.lineTo(e.offsetX, e.offsetY); 
                lienzo.stroke();
                // Actualizamos el punto anterior para el siguiente movimiento
                xAnterior = e.offsetX;
                yAnterior = e.offsetY;
            } else if(tipoHerramienta === 'recta'){
                // Restauramos el dibujo original para borrar la línea "fantasma" anterior
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.moveTo(xAnterior, yAnterior);
                lienzo.lineTo(e.offsetX, e.offsetY);
                lienzo.stroke();
            } else if(tipoHerramienta === 'rectangulo'){
                // Restauramos el dibujo original para borrar la línea "fantasma" anterior
                lienzo.putImageData(snapshot, 0, 0);
                lienzo.beginPath();
                lienzo.strokeRect(xAnterior, yAnterior,e.offsetX-xAnterior, e.offsetY-yAnterior);
                lienzo.stroke();
            } 
        }

        function zonaImagenes() {
            
            foto.src="../media/images/paisaje.png";
            foto.addEventListener("load",()=>{
                
                c.drawImage(foto, 0, 0)
                console.log(c.getImageData(0,0,300,168));

                imgData = c.getImageData(0,0,300,168);
                let aFoto = imgData.data;
                const aFoto2 = imgData.data;

                copiaImagen = Array.from(imgData.data);

                barraRojo.addEventListener("input",()=>{
                    modificarImagen(c,aFoto,aFoto2,barraRojo.value,barraVerde.value,barraAzul.value)
                })
                barraVerde.addEventListener("input",()=>{
                    modificarImagen(c,aFoto,aFoto2,barraRojo.value,barraVerde.value,barraAzul.value)
                })
                barraAzul.addEventListener("input",()=>{
                    modificarImagen(c,aFoto,aFoto2,barraRojo.value,barraVerde.value,barraAzul.value)
                })
                resetBarras.addEventListener('click',()=>{
                    barraRojo.value=0
                    barraVerde.value=0
                    barraAzul.value=0
                    modificarImagen(c,aFoto,aFoto2,0,0,0)
                })
            })
        }
        
        function modificarImagen(c,aFoto, aFoto2,r,g,b) {

            for (let i = 0; i < aFoto.length; i+=4) {
                
                aFoto[i] = (copiaImagen[i]+(255*barraRojo.value/100))>255?255:(copiaImagen[i]+(255*barraRojo.value/100));
                aFoto[i + 1] = (copiaImagen[i + 1] + (255 * barraVerde.value / 100))>255?255:(copiaImagen[i + 1] + (255 * barraVerde.value / 100));
                aFoto[i + 2] = (copiaImagen[i + 2] + (255 * barraAzul.value / 100))>255?255:(copiaImagen[i + 2] + (255 * barraAzul.value / 100));
            }
            c.putImageData(imgData,0,0);
        }    


    </script>
</body>
</html>